services:
  gateway:
    build: 
      context: .
      dockerfile: Dockerfile
    image: open-z3950-gateway:latest
    container_name: z3950-gateway
    restart: unless-stopped
    ports:
      - "${PORT:-8899}:8899" # Web UI + API Gateway
      - "${ZSERVER_PORT:-2100}:2100" # Z39.50 Server
    environment:
      - DB_PROVIDER=${DB_PROVIDER:-sqlite}
      - DB_PATH=/app/data/gateway.db
      - DB_DSN=host=postgres-db user=postgres password=${POSTGRES_PASSWORD:-example} dbname=z3950 sslmode=disable
      - ZSERVER_PORT=2100
      - PORT=8899
      - GATEWAY_API_KEY=${GATEWAY_API_KEY:-123456}
      - ZSERVER_ALLOWED_IPS=${ZSERVER_ALLOWED_IPS:-0.0.0.0/0}
    volumes:
      - ./data/gateway:/app/data
    depends_on:
      postgres-db:
        condition: service_healthy
        required: false # Only required if DB_PROVIDER=postgres

  postgres-db:
    image: postgres:15-alpine
    container_name: z3950-postgres
    profiles: ["with-postgres"] # Only starts if requested
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-example}
      - POSTGRES_DB=z3950
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

volumes:
  gateway-data:
  postgres-data:
services:
  gateway:
    build: 
      context: .
      dockerfile: Dockerfile
    image: open-z3950-gateway:latest
    container_name: z3950-gateway
    restart: unless-stopped
    ports:
      - "${PORT:-8899}:8899" # Web UI + API Gateway
      - "${ZSERVER_PORT:-2100}:2100" # Z39.50 Server
    environment:
      - DB_PROVIDER=${DB_PROVIDER:-sqlite}
      - DB_PATH=/app/data/gateway.db
      - DB_DSN=host=postgres-db user=postgres password=${POSTGRES_PASSWORD:-example} dbname=z3950 sslmode=disable
      - ZSERVER_PORT=2100
      - PORT=8899
      - GATEWAY_API_KEY=${GATEWAY_API_KEY:-123456}
      - ZSERVER_ALLOWED_IPS=${ZSERVER_ALLOWED_IPS:-0.0.0.0/0}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317 # Send traces to Jaeger
    volumes:
      - ./data/gateway:/app/data
    depends_on:
      postgres-db:
        condition: service_healthy
        required: false
      jaeger:
        condition: service_started

  postgres-db:
    image: postgres:15-alpine
    container_name: z3950-postgres
    profiles: ["with-postgres"]
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-example}
      - POSTGRES_DB=z3950
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: z3950-jaeger
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317"   # OTLP gRPC
    environment:
      - COLLECTOR_OTLP_ENABLED=true

volumes:
  gateway-data:
  postgres-data:
